<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">




  <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
  <script src="http://codeorigin.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
  <!-- // <script src="lib/jquery.min.js"></script> -->


  <!-- Bootstrap -->
  <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Optional theme -->
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap-theme.min.css">

  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="lib/bootstrap/js/bootstrap.min.js"></script>

  <!-- bootstrap widget theme -->
  <link rel="stylesheet" href="lib/tablesorter/css/theme.bootstrap.css">
  <!-- tablesorter plugin -->
  <script src="lib/tablesorter/js/jquery.tablesorter.js"></script>
  <!-- tablesorter widget file - loaded after the plugin -->
  <script src="lib/tablesorter/js/jquery.tablesorter.widgets.js"></script>




  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
  <!-- <link rel="stylesheet" href="lib/leaflet/dist/leaflet.css" /> -->
 <!--[if lte IE 8]>
     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
 <![endif]-->
  <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>



  <script src="lib/L.GeoSearch/js/l.control.geosearch.js"></script>
  <script src="lib/L.GeoSearch/js/l.geosearch.provider.google.js"></script>
  <link rel="stylesheet" href="lib/L.GeoSearch/css/l.geosearch.css" />

  <script src="lib/Leaflet.label/leaflet.label.js"></script>
  <link rel="stylesheet" href="lib/Leaflet.label/leaflet.label.css" />

  <!-- Include one of jTable styles. -->
  <link href="lib/jtable/themes/metro/blue/jtable.min.css" rel="stylesheet" type="text/css" />
 
  <!-- Include jTable script file. -->
  <!-- // <script src="lib/jtable/jquery.jtable.min.js" type="text/javascript"></script> -->
  <script src="lib/jtable/jquery.jtable.js" type="text/javascript"></script>

  <script src="data/itemas_es_final_single.geojson" type="text/javascript"></script>


  <style>
    /*body { */
      /*margin:0; padding:0; }*/
    #map { 
      /*position:absolute; */
      /*top: -10; */
      /*bottom:0; */
      /*width:100%; */
      /*height: 100%;*/
    }

  .oc-logo {
    display: inline-block;
    width: 108px;
    height: 20px;
    line-height: 20px;
    background: url(assets/images/oc-power.png) no-repeat;
    text-indent: -999px;
    overflow: hidden;
  }

  /* Custom container */
  .container-full {
    margin: 0 auto;
    width: 100%;
    padding: 0 15px;
  }

  </style>
</head>
<body>

<div class="container-full">
<div class="container">

  <div class="row">
    <div id="map" class="col-lg-6" style="height: 600px; position: relative;"></div>
    <!-- <div id="table2" class="col-md-6"></div> -->
    <div id="table-wrapper" class="col-lg-6"></div>
  </div>

</div>
</div>

<script>

    var groups = {};

    var layers = {};

    var geo = L.geoJson(data, {
      onEachFeature: function(feature, layer) {
        // console.debug(feature);

        // Fix lat/lng
        var tmp = layer._latlng.lat;
        layer._latlng.lat = layer._latlng.lng;
        layer._latlng.lng = tmp;

        var props = feature.properties;
        var area = props.area_clinica;

        // Popup HTML
        var html = '<h3>' + props.data.insticucion.standard + '</h3>';
          // 'Descripción: ' + props.data.proyecto.descripcion;
        layer.bindPopup(html);
        layer.bindLabel(props.data.insticucion.standard, {noHide: true});
        // layer.bindLabel(props.data.insticucion.standard);


        // Add to the correct area layer group
        if (!groups.hasOwnProperty(area)) {
          groups[area] = L.layerGroup();
        }
        groups[area].addLayer(layer);
      }
    });

    var map = L.map('map', {
      center: [40.47, -3.59],
      zoom: 6
      // layers: groups['Hepatología'],
    });

    // new L.Control.GeoSearch({
    //   provider: new L.GeoSearch.Provider.Google(),
    //   zoomLevel: 12,
    //   searchLabel: "buscar..."
    // }).addTo(map);

    var cloudmade = L.tileLayer('http://{s}.tile.cloudmade.com/{key}/{styleId}/256/{z}/{x}/{y}.png', {
      // attribution: 'Developed by <a href="http://marzeelabs.org" target="_blank">Marzee Labs</a>. Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
      attribution: '<b>Developed by <a href="http://openconsortium.eu/" target="_blank" class="oc-logo">Open Consortium</a>.</b> Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
      key: 'BC9A493B41014CAABB98F0471D759707',
      styleId: 22677
    }).addTo(map);

    L.control.layers([],groups).addTo(map);

    console.log(groups);

    // map.on('layeradd', function(layer) {
    // //   // layer.layer.showLabel();
    // //   // console.log(layer);
    //   if (layer.layer.showLabel) {
    //     // layer.
    // //     // console.log(layer);
    // //     // console.log(layer.layer.feature.properties.data.insticucion.standard);
    // //     layer.layer.showLabel();
    //   }


    //   // console.log(layer);
    //   // console.log("ADD");
    //   // console.log(layer);
    //   // console.log("ADD");
    // });

    // map.on('layerremove', function(l) {
    //   // console.log("REMOVE");
    // });

    map.on('overlayremove', function(layer) {
      delete layers[layer.name];
      drawTable();
    });

    map.on('overlayadd', function(layer) {
      layers[layer.name] = 1;
      drawTable();


      // groups[name].eachLayer(function(l) {
      //   // console.log(l.feature.properties.data.insticucion.standard);

      //   // console.log(l.feature._id);
      //   // console.log(l);

      //   data = l.feature.properties.data;

      //   table.jtable('addRecord', {
      //     record: {
      //       Responsable: data.responsable,
      //       Name: data.insticucion.original,
      //       Area: l.feature.properties.area_clinica,
      //       Id: l._leaflet_id
      //      },
      //   clientOnly: true
      //   });

      // });

    });

    function drawTable() {
      // table.jtable('destroy');
      // drawTable();


      var table = $('<table></table>').attr('id', 'table').addClass('table table-striped table-hover table-condensed');
      var thead = $('<thead></thead');
      var tr = $('<tr></tr>');

      columns = ['Institución', 'Área Clínica']
      columns.forEach(function(k) {
        var th = $('<th></th>').text(k);
        tr.append(th);
      });

      thead.append(tr);
      table.append(thead);



      var tbody = $('<tbody></tbody>');
      
      for (l in layers) {
        groups[l].eachLayer(function(l2) {

          data = l2.feature.properties.data;

          var row = $('<tr></tr>');

          var col1 = $('<td></td>').text(data.insticucion.original);
          var col2 = $('<td></td>').text(l2.feature.properties.area_clinica);


          row.append(col1);
          row.append(col2);


          tbody.append(row);

        });
      }

      table.append(tbody);

      $('#table-wrapper').empty().append(table);
      $('#table').tablesorter({
                // this will apply the bootstrap theme if "uitheme" widget is included
        // the widgetOptions.uitheme is no longer required to be set
        theme : "bootstrap",

        widthFixed: true,

        headerTemplate : '{content} {icon}', // new in v2.7. Needed to add the bootstrap icon!

        // widget code contained in the jquery.tablesorter.widgets.js file
        // use the zebra stripe widget if you plan on hiding any rows (filter widget)
        widgets : [ "uitheme", "filter", "zebra" ],

        widgetOptions : {
          // using the default zebra striping class name, so it actually isn't included in the theme variable above
          // this is ONLY needed for bootstrap theming if you are using the filter widget, because rows are hidden
          zebra : ["even", "odd"],

          // reset filters button
          filter_reset : ".reset"

          // set the uitheme widget to use the bootstrap theme class names
          // this is no longer required, if theme is set
          // ,uitheme : "bootstrap"

        }

      });
    }


  $.extend($.tablesorter.themes.bootstrap, {
    // these classes are added to the table. To see other table classes available,
    // look here: http://twitter.github.com/bootstrap/base-css.html#tables
    table      : 'table table-bordered',
    header     : 'bootstrap-header', // give the header a gradient background
    footerRow  : '',
    footerCells: '',
    icons      : '', // add "icon-white" to make them white; this icon class is added to the <i> in the header
    sortNone   : 'bootstrap-icon-unsorted',
    sortAsc    : 'icon-chevron-up glyphicon glyphicon-chevron-up',     // includes classes for Bootstrap v2 & v3
    sortDesc   : 'icon-chevron-down glyphicon glyphicon-chevron-down', // includes classes for Bootstrap v2 & v3
    active     : '', // applied when column is sorted
    hover      : '', // use custom css here - bootstrap class may not override it
    filterRow  : '', // filter row class
    even       : '', // odd row zebra striping
    odd        : ''  // even row zebra striping
  });

    drawTable();






</script>
</body>
</html>
